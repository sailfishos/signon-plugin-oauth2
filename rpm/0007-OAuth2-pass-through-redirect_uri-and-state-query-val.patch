From b1c1dc8152ab88b777b883a42dc6cb5b35fa6dbc Mon Sep 17 00:00:00 2001
From: Chris Adams <chris.adams@jollamobile.com>
Date: Mon, 20 May 2019 16:47:31 +1000
Subject: [PATCH] OAuth2: pass through redirect_uri and state query values

---
 src/oauth2plugin.cpp | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

diff --git a/src/oauth2plugin.cpp b/src/oauth2plugin.cpp
index 77aa862..a5dd0ad 100644
--- a/src/oauth2plugin.cpp
+++ b/src/oauth2plugin.cpp
@@ -69,6 +69,7 @@ const QString CLIENT_ID = QString("client_id");
 const QString CLIENT_SECRET = QString("client_secret");
 const QString REFRESH_TOKEN = QString("refresh_token");
 const QString AUTH_ERROR = QString("error");
+const QString STATE = QString("state");
 
 const QByteArray CONTENT_TYPE = QByteArray("Content-Type");
 const QByteArray CONTENT_APP_URLENCODED = QByteArray("application/x-www-form-urlencoded");
@@ -395,10 +396,12 @@ void OAuth2Plugin::userActionFinished(const SignOn::UiSessionData &data)
         // 4. Refresh Token (refresh_token)
         QUrl newUrl;
         if (url.hasQueryItem(AUTH_CODE)) {
-            QString code = url.queryItemValue(AUTH_CODE);
             newUrl.addQueryItem(GRANT_TYPE, AUTHORIZATION_CODE);
-            newUrl.addQueryItem(AUTH_CODE, code);
-            newUrl.addQueryItem(REDIRECT_URI, d->m_oauth2Data.RedirectUri());
+            newUrl.addQueryItem(AUTH_CODE, url.queryItemValue(AUTH_CODE));
+            newUrl.addQueryItem(REDIRECT_URI, url.hasQueryItem(REDIRECT_URI) ? url.queryItemValue(REDIRECT_URI) : d->m_oauth2Data.RedirectUri());
+            if (url.hasQueryItem(STATE)) {
+                newUrl.addQueryItem(STATE, url.queryItemValue(STATE));
+            }
             sendOAuth2PostRequest(newUrl,
                                   GrantType::AuthorizationCode);
         }
-- 
2.17.1

